"""
UI tests for scheduler management.

Tests creating schedules through the Streamlit UI.
"""
import pytest
import uuid
import os
import sys
from streamlit.testing.v1 import AppTest

# Ensure admin directory is in Python path
if '/app/admin' not in sys.path:
    sys.path.insert(0, '/app/admin')

from admin.services.scheduler_service import list_schedules, get_schedule


@pytest.mark.integration
@pytest.mark.ui
class TestSchedulerUI:
    """Test scheduler creation through Streamlit UI."""

    def test_create_custom_schedule_via_ui(self, db_transaction, clean_test_data):
        """
        Test creating a custom scheduled job through the UI form.

        Verifies:
        - Form submission works
        - Success message appears
        - Database record is created with correct cron expression
        """
        # Load scheduler page
        original_cwd = os.getcwd()
        os.chdir('/app/admin')
        try:
            at = AppTest.from_file("pages/scheduler.py")
            at.run()
        finally:
            os.chdir(original_cwd)

        # Navigate to "Create New" tab (tab index 1)
        at.tabs[1].select()
        at.run()

        # Generate unique job name
        job_name = f"UITest_Job_{uuid.uuid4().hex[:8]}"

        # Fill form fields (based on scheduler.py render_scheduler_form)
        # Job Name (line 86-90)
        at.text_input[0].set_value(job_name)

        # Job Type selectbox (line 97-102) - select 'custom'
        at.selectbox[0].select("custom")
        at.run()

        # Cron expression fields (lines 118-146)
        at.text_input[1].set_value("0")    # minute
        at.text_input[2].set_value("6")    # hour
        at.text_input[3].set_value("*")    # day
        at.text_input[4].set_value("*")    # month
        at.text_input[5].set_value("*")    # weekday

        # Script path (line 187-192) - required for custom jobs
        at.text_input[6].set_value("/app/etl/jobs/test_job.py")

        # is_active checkbox (line 196-199) - leave checked (default True)

        # Submit form
        at.form_submit_button[0].click()
        at.run()

        # Verify success message
        success_messages = [msg.value for msg in at.success]
        assert any(job_name in msg for msg in success_messages), \
            f"Expected success message with '{job_name}', got: {success_messages}"

        # Verify database record
        schedules = list_schedules()
        created_schedule = next(
            (s for s in schedules if s['job_name'] == job_name), None
        )

        assert created_schedule is not None, \
            f"Schedule '{job_name}' not found in database"
        assert created_schedule['job_type'] == 'custom'
        assert created_schedule['cron_minute'] == '0'
        assert created_schedule['cron_hour'] == '6'
        assert created_schedule['cron_day'] == '*'
        assert created_schedule['cron_month'] == '*'
        assert created_schedule['cron_weekday'] == '*'
        assert created_schedule['script_path'] == '/app/etl/jobs/test_job.py'
        assert created_schedule['is_active'] is True

    def test_create_inbox_processor_schedule_via_ui(
        self,
        created_import_config,
        db_transaction,
        clean_test_data
    ):
        """
        Test creating an inbox_processor schedule linked to import config.

        Verifies:
        - Can select inbox_processor job type
        - Can link to existing import config
        - No script path required for inbox_processor
        """
        # Load scheduler page
        original_cwd = os.getcwd()
        os.chdir('/app/admin')
        try:
            at = AppTest.from_file("pages/scheduler.py")
            at.run()
        finally:
            os.chdir(original_cwd)

        # Navigate to "Create New" tab
        at.tabs[1].select()
        at.run()

        # Generate unique job name
        job_name = f"UITest_Inbox_{uuid.uuid4().hex[:8]}"

        # Fill form fields
        at.text_input[0].set_value(job_name)

        # Select inbox_processor job type
        at.selectbox[0].select("inbox_processor")
        at.run()

        # Cron expression - every 5 minutes
        at.text_input[1].set_value("*/5")  # minute
        at.text_input[2].set_value("*")    # hour
        at.text_input[3].set_value("*")    # day
        at.text_input[4].set_value("*")    # month
        at.text_input[5].set_value("*")    # weekday

        # Configuration selectbox (line 173-179) - select specific config
        # The selectbox will have config options loaded
        # Select the first available config (which should be our created_import_config)
        if len(at.selectbox) > 1:
            at.selectbox[1].select_index(1)  # Index 0 is "All", index 1 is first config

        # Submit form
        at.form_submit_button[0].click()
        at.run()

        # Verify success message
        success_messages = [msg.value for msg in at.success]
        assert any(job_name in msg for msg in success_messages), \
            f"Expected success message with '{job_name}', got: {success_messages}"

        # Verify database
        schedules = list_schedules()
        created_schedule = next(
            (s for s in schedules if s['job_name'] == job_name), None
        )

        assert created_schedule is not None
        assert created_schedule['job_type'] == 'inbox_processor'
        assert created_schedule['cron_minute'] == '*/5'
        assert created_schedule['script_path'] is None  # Not required for inbox_processor

    def test_schedule_validation_errors(self, db_transaction, clean_test_data):
        """
        Test form validation for scheduler.

        Verifies:
        - Empty job name shows error
        - Custom job without script path shows error
        """
        # Load scheduler page
        original_cwd = os.getcwd()
        os.chdir('/app/admin')
        try:
            at = AppTest.from_file("pages/scheduler.py")
            at.run()
        finally:
            os.chdir(original_cwd)

        # Navigate to "Create New" tab
        at.tabs[1].select()
        at.run()

        # Leave job name empty
        at.text_input[0].set_value("")

        # Select custom job type
        at.selectbox[0].select("custom")
        at.run()

        # Fill cron but leave script path empty
        at.text_input[1].set_value("0")
        at.text_input[2].set_value("8")
        at.text_input[3].set_value("*")
        at.text_input[4].set_value("*")
        at.text_input[5].set_value("*")

        # Leave script path empty (text_input[6])
        at.text_input[6].set_value("")

        # Submit form
        at.form_submit_button[0].click()
        at.run()

        # Verify error messages
        error_messages = [msg.value for msg in at.error]
        assert len(error_messages) > 0, "Expected validation errors"
        assert any('required' in msg.lower() for msg in error_messages), \
            f"Expected validation error for required fields, got: {error_messages}"

    def test_schedule_invalid_cron_expression(self, db_transaction, clean_test_data):
        """
        Test that invalid cron expression shows validation error.

        Verifies:
        - Invalid cron values trigger error
        """
        # Load scheduler page
        original_cwd = os.getcwd()
        os.chdir('/app/admin')
        try:
            at = AppTest.from_file("pages/scheduler.py")
            at.run()
        finally:
            os.chdir(original_cwd)

        # Navigate to "Create New" tab
        at.tabs[1].select()
        at.run()

        # Fill form with valid job name
        job_name = f"UITest_Invalid_{uuid.uuid4().hex[:8]}"
        at.text_input[0].set_value(job_name)

        # Select custom job type
        at.selectbox[0].select("custom")
        at.run()

        # Fill invalid cron expression (hour out of range)
        at.text_input[1].set_value("0")
        at.text_input[2].set_value("25")   # Invalid hour (0-23)
        at.text_input[3].set_value("*")
        at.text_input[4].set_value("*")
        at.text_input[5].set_value("*")

        # Fill script path
        at.text_input[6].set_value("/app/etl/jobs/test.py")

        # Submit form
        at.form_submit_button[0].click()
        at.run()

        # Verify error message about cron validation
        error_messages = [msg.value for msg in at.error]
        assert len(error_messages) > 0, "Expected cron validation error"
        assert any('cron' in msg.lower() or 'hour' in msg.lower()
                   for msg in error_messages), \
            f"Expected cron validation error, got: {error_messages}"

    def test_schedule_with_weekday_cron(self, db_transaction, clean_test_data):
        """
        Test creating schedule with weekday-only cron expression.

        Verifies:
        - Can create schedule that runs only on weekdays
        - Cron expression is saved correctly
        """
        # Load scheduler page
        original_cwd = os.getcwd()
        os.chdir('/app/admin')
        try:
            at = AppTest.from_file("pages/scheduler.py")
            at.run()
        finally:
            os.chdir(original_cwd)

        # Navigate to "Create New" tab
        at.tabs[1].select()
        at.run()

        # Generate unique job name
        job_name = f"UITest_Weekdays_{uuid.uuid4().hex[:8]}"

        # Fill form
        at.text_input[0].set_value(job_name)

        # Select custom job type
        at.selectbox[0].select("custom")
        at.run()

        # Daily at 8 AM, weekdays only
        at.text_input[1].set_value("0")      # minute
        at.text_input[2].set_value("8")      # hour
        at.text_input[3].set_value("*")      # day
        at.text_input[4].set_value("*")      # month
        at.text_input[5].set_value("1-5")    # weekday (Mon-Fri)

        # Script path
        at.text_input[6].set_value("/app/etl/jobs/weekday_job.py")

        # Submit form
        at.form_submit_button[0].click()
        at.run()

        # Verify success
        success_messages = [msg.value for msg in at.success]
        assert any(job_name in msg for msg in success_messages)

        # Verify database
        schedules = list_schedules()
        created_schedule = next(
            (s for s in schedules if s['job_name'] == job_name), None
        )

        assert created_schedule is not None
        assert created_schedule['cron_hour'] == '8'
        assert created_schedule['cron_weekday'] == '1-5'
