"""
UI tests for reference data management (datasources and dataset types).

Tests creating datasources and dataset types through the Streamlit UI.
"""
import pytest
import uuid
import os
import sys
from streamlit.testing.v1 import AppTest

# Ensure admin directory is in Python path
if '/app/admin' not in sys.path:
    sys.path.insert(0, '/app/admin')

from admin.services.reference_data_service import (
    get_datasource,
    list_datasources,
    get_datasettype,
    list_datasettypes,
)


@pytest.mark.integration
@pytest.mark.ui
class TestReferenceDataUI:
    """Test reference data creation through Streamlit UI."""

    def test_create_datasource_via_ui(self, db_transaction, clean_test_data):
        """
        Test creating a datasource through the UI form.

        Verifies:
        - Form submission works
        - Success message appears
        - Database record is created
        """
        # Load reference data page (from admin directory for relative imports)
        original_cwd = os.getcwd()
        os.chdir('/app/admin')
        try:
            at = AppTest.from_file("pages/reference_data.py")
            at.run()
        finally:
            os.chdir(original_cwd)

        # Navigate to Data Sources tab (tab 0), then Add New sub-tab (tab 1)
        at.tabs[0].select()
        at.run()

        # Select "Add New" sub-tab within Data Sources
        at.tabs[1].select()
        at.run()

        # Generate unique datasource name
        datasource_name = f"UITest_DS_{uuid.uuid4().hex[:8]}"
        datasource_desc = "Test datasource created via UI"

        # Fill form fields (based on render_datasource_form in forms.py)
        at.text_input[0].set_value(datasource_name)
        at.text_area[0].set_value(datasource_desc)

        # Submit form (datasource_form_create)
        at.form_submit_button[0].click()
        at.run()

        # Verify success message
        success_messages = [msg.value for msg in at.success]
        assert any(datasource_name in msg for msg in success_messages), \
            f"Expected success message with '{datasource_name}', got: {success_messages}"

        # Verify database record
        datasources = list_datasources()
        created_ds = next((ds for ds in datasources if ds['sourcename'] == datasource_name), None)
        assert created_ds is not None, f"Datasource '{datasource_name}' not found in database"
        assert created_ds['description'] == datasource_desc

    def test_create_datasettype_via_ui(self, db_transaction, clean_test_data):
        """
        Test creating a dataset type through the UI form.

        Verifies:
        - Form submission works
        - Success message appears
        - Database record is created
        """
        # Load reference data page
        original_cwd = os.getcwd()
        os.chdir('/app/admin')
        try:
            at = AppTest.from_file("pages/reference_data.py")
            at.run()
        finally:
            os.chdir(original_cwd)

        # Navigate to Dataset Types tab (tab 1), then Add New sub-tab (tab 1)
        at.tabs[1].select()
        at.run()

        # Select "Add New" sub-tab within Dataset Types
        at.tabs[1].select()
        at.run()

        # Generate unique dataset type name
        datasettype_name = f"UITest_DT_{uuid.uuid4().hex[:8]}"
        datasettype_desc = "Test dataset type created via UI"

        # Fill form fields (based on render_datasettype_form in forms.py)
        at.text_input[0].set_value(datasettype_name)
        at.text_area[0].set_value(datasettype_desc)

        # Submit form (datasettype_form_create)
        at.form_submit_button[0].click()
        at.run()

        # Verify success message
        success_messages = [msg.value for msg in at.success]
        assert any(datasettype_name in msg for msg in success_messages), \
            f"Expected success message with '{datasettype_name}', got: {success_messages}"

        # Verify database record
        datasettypes = list_datasettypes()
        created_dt = next((dt for dt in datasettypes if dt['typename'] == datasettype_name), None)
        assert created_dt is not None, f"Dataset type '{datasettype_name}' not found in database"
        assert created_dt['description'] == datasettype_desc

    def test_datasource_name_validation(self, db_transaction, clean_test_data):
        """
        Test that empty datasource name shows validation error.
        """
        # Load reference data page
        original_cwd = os.getcwd()
        os.chdir('/app/admin')
        try:
            at = AppTest.from_file("pages/reference_data.py")
            at.run()
        finally:
            os.chdir(original_cwd)

        # Navigate to Data Sources -> Add New
        at.tabs[0].select()
        at.run()
        at.tabs[1].select()
        at.run()

        # Leave name empty, fill description
        at.text_input[0].set_value("")
        at.text_area[0].set_value("Description without name")

        # Submit form
        at.form_submit_button[0].click()
        at.run()

        # Verify error message appears
        error_messages = [msg.value for msg in at.error]
        assert any('required' in msg.lower() for msg in error_messages), \
            f"Expected validation error for empty name, got: {error_messages}"

    def test_datasettype_name_validation(self, db_transaction, clean_test_data):
        """
        Test that empty dataset type name shows validation error.
        """
        # Load reference data page
        original_cwd = os.getcwd()
        os.chdir('/app/admin')
        try:
            at = AppTest.from_file("pages/reference_data.py")
            at.run()
        finally:
            os.chdir(original_cwd)

        # Navigate to Dataset Types -> Add New
        at.tabs[1].select()
        at.run()
        at.tabs[1].select()
        at.run()

        # Leave name empty, fill description
        at.text_input[0].set_value("")
        at.text_area[0].set_value("Description without name")

        # Submit form
        at.form_submit_button[0].click()
        at.run()

        # Verify error message appears
        error_messages = [msg.value for msg in at.error]
        assert any('required' in msg.lower() for msg in error_messages), \
            f"Expected validation error for empty name, got: {error_messages}"
